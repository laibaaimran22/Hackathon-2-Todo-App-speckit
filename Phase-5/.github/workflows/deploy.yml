name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ocir.io  # Oracle Cloud Infrastructure Registry
  IMAGE_NAME: todo-evolution-app

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: Run tests
      run: |
        # Add test commands here
        echo "Running tests..."
        # Example: python -m pytest tests/

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Oracle Cloud Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.OCI_USERNAME }}
        password: ${{ secrets.OCI_AUTH_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ secrets.OCI_TENANCY }}/todo/${{ env.IMAGE_NAME }}

    - name: Build and push frontend
      uses: docker/build-push-action@v5
      with:
        context: .
        file: frontend/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ secrets.OCI_TENANCY }}/todo/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}

    - name: Build and push backend
      uses: docker/build-push-action@v5
      with:
        context: .
        file: backend/Dockerfile
        push: true
        tags: ${{ env.REGISTRY }}/${{ secrets.OCI_TENANCY }}/todo/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Oracle Cloud CLI
      run: |
        curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh -o install.sh
        chmod +x install.sh
        ./install.sh --accept-all-defaults

    - name: Configure kubectl for Oracle Cloud
      run: |
        # Set up OCI configuration
        mkdir -p ~/.oci
        echo "${{ secrets.OCI_CONFIG }}" > ~/.oci/config
        echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
        chmod 600 ~/.oci/oci_api_key.pem

        # Install kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

        # Get K8s cluster kubeconfig
        oci ce cluster create-kubeconfig --cluster-id ${{ secrets.OKE_CLUSTER_ID }} --file $HOME/.kube/config --region ${{ secrets.OCI_REGION }}

    - name: Install Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.13.0

    - name: Deploy to Oracle Cloud
      run: |
        # Update the image tags in values file
        sed -i "s|tag: latest|tag: ${{ github.sha }}|g" helm-charts/todo-app/values.yaml

        # Add Dapr Helm repo
        helm repo add dapr https://daprio.github.io/helm-charts
        helm repo update

        # Install Dapr
        helm upgrade --install dapr dapr/dapr --namespace dapr-system --create-namespace --wait

        # Deploy the application
        helm upgrade --install todo-app ./helm-charts/todo-app --values ./helm-charts/todo-app/values.yaml --atomic --timeout=10m

    - name: Verify deployment
      run: |
        kubectl get pods -n default
        kubectl get services -n default
        kubectl get ingress -n default