# CRUD Operations Debugging Guide

## Issues Found & Fixed

### 1. **CORS Configuration Issue**
**Problem**: The backend CORS middleware was configured too permissively with `["*"]` for methods and headers
**Fix**: Updated to only allow specific HTTP methods and headers:
- Allowed methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
- Allowed headers: Content-Type, Authorization

**Backend Change**: `main.py` CORS middleware configuration

### 2. **Missing Environment Variable Validation**
**Problem**: If `NEXT_PUBLIC_API_URL` is not properly set on Vercel, API calls will fail
**Solution**: Added debug endpoint at `/api/debug` to verify all environment variables

### 3. **JWT Secret Mismatch**
**Problem**: Frontend (Vercel) and Backend (HuggingFace) must use the same JWT_SECRET or BETTER_AUTH_SECRET
**Verification Needed**: Ensure both environments have matching secrets:
- HuggingFace: `BETTER_AUTH_SECRET=nN7vZ0aizxDTIC/m1LMh9JRiYlPDXXKhp1q9GWDX7Ec=`
- Vercel: Must have the exact same value for `BETTER_AUTH_SECRET` and `JWT_SECRET`

### 4. **Improved Error Logging**
Added comprehensive logging to:
- `backend/main.py`: Task CRUD operations now log request details
- `frontend/src/app/dashboard/page.tsx`: Better error reporting for fetch failures
- `frontend/src/lib/api-client.ts`: API error details logged to console

## Verification Steps

### Step 1: Check Backend Health (HuggingFace Spaces)
Visit: `https://laibaaaimran-phase3-chatbot-backend.hf.space/health`
Expected response: `{"status": "healthy", "version": "1.0.0"}`

### Step 2: Check CORS Configuration (HuggingFace Spaces)
Visit: `https://laibaaaimran-phase3-chatbot-backend.hf.space/api/debug/cors`
Expected response: Should show your Vercel URL in cors_origins

### Step 3: Test Frontend Debug Endpoint (Vercel)
Visit: `https://hackathon-2-todo-app-speckit.vercel.app/api/debug`
Expected response: Environment variables and backend connectivity status

### Step 4: Check Browser Console (Frontend)
1. Open DevTools (F12) on your Vercel app
2. Go to Console tab
3. Perform a CRUD operation (create/update/delete task)
4. Look for API error messages starting with `[API Error]` or `[Dashboard]`

## Common Causes of 500 Errors on Vercel

1. **Environment Variables Missing or Mismatched**
   - Check: JWT_SECRET and BETTER_AUTH_SECRET match between Vercel and HuggingFace
   - Check: NEXT_PUBLIC_API_URL is correctly set to HuggingFace URL
   - Check: Database connection string is the same

2. **Authentication Token Issues**
   - The JWT token generated by Better Auth might not have the correct format
   - The backend might not be extracting the user_id correctly
   - Check backend logs for: `[DEBUG] Successfully extracted user_id`

3. **CORS Blocking Requests**
   - Frontend makes request from https://hackathon-2-todo-app-speckit.vercel.app
   - Backend must accept this origin
   - Check: CORS_ORIGINS on HuggingFace includes https://hackathon-2-todo-app-speckit.vercel.app

4. **Database Connection Issues**
   - Verify DATABASE_URL is accessible from HuggingFace
   - Ensure SSL mode is enabled: `?sslmode=require`

## Manual CRUD Testing

### Using curl (from terminal):
```bash
# 1. Create a task
curl -X POST https://laibaaaimran-phase3-chatbot-backend.hf.space/api/tasks \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title":"Test Task","description":"Testing CRUD"}'

# 2. Get all tasks
curl -X GET https://laibaaaimran-phase3-chatbot-backend.hf.space/api/tasks \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# 3. Update a task
curl -X PUT https://laibaaaimran-phase3-chatbot-backend.hf.space/api/tasks/1 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"title":"Updated Title"}'

# 4. Toggle task completion
curl -X PATCH https://laibaaaimran-phase3-chatbot-backend.hf.space/api/tasks/1/complete \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# 5. Delete a task
curl -X DELETE https://laibaaaimran-phase3-chatbot-backend.hf.space/api/tasks/1 \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## Files Modified

### Backend Changes:
1. `Phase-3/backend/main.py`
   - Updated CORS middleware configuration
   - Added enhanced logging to task creation
   - Added `/api/debug/cors` endpoint

### Frontend Changes:
1. `Phase-3/frontend/src/app/dashboard/page.tsx`
   - Added detailed logging for API calls
   - Better error handling and reporting

2. `Phase-3/frontend/src/lib/api-client.ts`
   - Enhanced error logging
   - Better error message extraction

3. `Phase-3/frontend/src/app/api/debug/route.ts`
   - New comprehensive debug endpoint
   - Environment validation
   - Backend connectivity check

## Next Steps

1. **Verify Environment Variables**
   - Check Vercel dashboard: Settings â†’ Environment Variables
   - Ensure all required variables are set

2. **Restart Backend**
   - Restart HuggingFace Space to apply CORS changes

3. **Test CRUD Operations**
   - Use the debug endpoints to verify connectivity
   - Check browser console for detailed error messages
   - Check HuggingFace logs for backend errors

4. **Monitor Logs**
   - HuggingFace: Check application startup logs
   - Vercel: Check function logs in Vercel dashboard
   - Browser: Check DevTools console
